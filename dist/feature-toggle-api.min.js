"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};exports.default=featuretoggleapi;var _showLogs=!1;function initVisibilities(){var i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t={};return Object.keys(i).forEach(function(e){t[e]=parseToFn(i[e])}),t}var _log=function(e){if(!0===_showLogs){var i=-1!=e.indexOf("<b>"),t=-1!=e.indexOf("visible"),n=-1!=e.indexOf("hidden"),r=e.replace("visible","%cvisible");if(r=r.replace("hidden","%chidden"),t)console.log(r,"color:green;font-weight:bold;");else if(n)console.log(r,"color:red;font-weight:bold;");else if(i){var l=[r=r.replace("<b>","%c"),"font-weight:bold;"];console.log.apply(null,l)}else console.log(e)}},parseToFn=function(e){return"boolean"==typeof e?function(){return e}:e},_logAndReturn=function(e,i){return _log(i),_log(""),e},getVisibility=function(e,i,t,n,r){if(null!=e){var l=e(t,n,r);return"boolean"==typeof l?l:_logAndReturn(!1,"The "+i+" returns "+l+". => Please return true or false. This result (and all non-boolean results) will return false.")}},getKey=function(e,i){var t=e.toLowerCase();return"string"==typeof i&&(t+="#"+i.toLowerCase()),t};function getRule(e,i){var t=e.split("#");return{name:t[0],variant:1<t.length?t[1]:void 0,data:i[e]}}function visibilityFnParams(e,i,t,n){if(null==e)throw new Error("feature.visibility(): 1st parameter name must be defined");if(1==arguments.length)throw new Error("feature.visibility(): 2nd parameter name must be a boolean or function, but is empty");var r=null,l=null,o=null;return null==t&&null==n?o=i:null==n?(r=i,o=t):(r=i,l=t,o=n),{name:e,variant:r,data:l,result:o}}function executeListener(e,i,t,n,r){e.forEach(function(e){e(i(t,n,r),t,n,r)})}function dataParams(e,i,t){return null==t?{name:e,variant:void 0,data:i}:{name:e,variant:i,data:t}}function _isVisible(e,i,t,n){if(_log('Check Visibility of <b>Feature "'+i+'", variant "'+(null==t?"":t)+'"'+(n?" with data "+JSON.stringify(n):"")+"."),null==i)throw new Error('The attribute "name" is required for tag <feature></feature>. Example: <feature name="aname"></feature>');var r=e._required,l=null!=e._required,o=getVisibility(r,"requiredVisibility",i,t,n),u=getKey(i,t),a=e[u],s=null!=e[u],f=getVisibility(a,"visibility function",i,t,n),d=null!=t,b=getKey(i,null),y=e[b],c=(e[b],getVisibility(y,"visibility function (only name)",i,t,n)),g=e._default,h=null!=e._default,v=getVisibility(g,"defaultVisibility",i,t,n);if(l){if(l&&!0===o)_log("The requiredVisibility rule returns true. This feature will be shown when no other rule rejects it.");else if(l&&!1===o)return _logAndReturn(!1,"The requiredVisibility rule returns false. This feature will be hidden.")}else _log("No requiredVisibility rule specified for this feature.");return s?_logAndReturn(f,"The visibility rule returns "+f+". This feature will be "+(f?"visible":"hidden")+"."):(_log("No visibility rule found matching name and variant."),d&&"boolean"==typeof c?_logAndReturn(c,"Found a visibility rule for name "+i+" without variants. The rule returns "+c+". => This feature will be "+(c?"visible":"hidden")+"."):(d&&_log("No rules found for name "+i+" without variants."),h?_logAndReturn(v,"Found a defaultVisibility rule. The rule returns "+v+". => This feature will be "+(v?"visible":"hidden")+"."):(_log("No default rule found."),l?_logAndReturn(!0,"Only the requiredVisibility rule was found. This returned true. => This feature will be visible."):_logAndReturn(!1,"No rules were found. This feature will be hidden."))))}function featuretoggleapi(e){var u=initVisibilities(e),a={},s=[];return{name:"feature-toggle-api",logAndReturn:function(e,i){return _logAndReturn(e,i)},log:function(e){_log(e)},setData:function(e,i,t){if(null==e)throw new Error("setData(): The name must of the feature must be defined, but ist undefined");var n=dataParams(e,i,t),r=getKey(n.name,n.variant),l=u[r];a[r]=n.data,executeListener(s,l,n.name,n.variant,n.data)},on:function(e,n,i){if(-1==["visibilityrule"].indexOf(e.toLowerCase()))throw new Error('Eventtype "'+e.toLowerCase()+'" does not exist. Only "visibilityrule" is valid');s.push(n),null!=i&&i.ignorePreviousRules||Object.keys(u).forEach(function(e){var i=getRule(e,a),t=u[e];n(t(i.name,i.variant,i.data),i.name,i.variant,i.data)})},showLogs:function(e,i,t){_showLogs=null==e||e},isVisible:function(e,i,t){return _isVisible(u,e,i,t)},visibility:function(e,i,t,n){var r=visibilityFnParams(e,i,t,n),l=getKey(r.name,r.variant),o=parseToFn(r.result);u[l]=o,a[l]=r.data,executeListener(s,o,r.name,r.variant,r.data)},requiredVisibility:function(e){if("function"!=typeof e)throw new Error("feature.requiredVisibility(): 1st parameter must be a function, but is "+(void 0===e?"undefined":_typeof(e)));u._required=parseToFn(e)},defaultVisibility:function(e){if("function"!=typeof e)throw new Error("feature.defaultVisibility(): 1st parameter must be a function, but is "+(void 0===e?"undefined":_typeof(e)));u._default=parseToFn(e)}}}